<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/BBVoting.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> BBVoting.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>42/63</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">42.59% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>23/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>8/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">67.61% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>48/71</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">  /**
 * Created on 2018-08-13 10:20
 * @summary: 
 * @author: Chris Nguyen
 */
pragma solidity ^0.4.24;
&nbsp;
import './BBStandard.sol';
import './BBLib.sol';
/**
 * @title BBVoting contract 
 */
contract BBVoting is BBStandard{
  address public bboReward = address(0x0);
&nbsp;
  event VotingRightsGranted(address indexed voter, uint256 numTokens);
  event VotingRightsWithdrawn(address indexed voter, uint256 numTokens);
  event VoteCommitted(address indexed voter, bytes jobHash);
  event VoteRevealed(address indexed voter, bytes jobHash, bytes32 secretHash, bytes32 cHash);
  function getPollID(bytes jobHash) private constant returns(uint256 r){
    r = bbs.getUint(BBLib.toB32(jobHash,'POLL_COUNTER'));
  }
  modifier isDisputeJob(bytes jobHash){
    uint256 jobStatus = bbs.getUint(BBLib.toB32(jobHash,'STATUS'));
    <span class="missing-if-branch" title="else path not taken" >E</span>require(jobStatus == 4);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getAddress(BBLib.toB32(jobHash, 'DISPUTE_WINNER'))==address(0x0));
    _;
  }
  function isAgaintsPoll(bytes jobHash) public constant returns(bool){
    return keccak256(bbs.getBytes(BBLib.toB32(jobHash, getPollID(jobHash),'AGAINST_PROOF')))!=keccak256("");
  }
  
<span class="fstat-no" title="function not covered" >  function setBBOReward(address rewardAddress) onlyOwner public</span>{
<span class="cstat-no" title="statement not covered" >    bboReward = rewardAddress</span>;
  }
&nbsp;
  /**
   * @dev request voting rights
   * 
   */
  function requestVotingRights(uint256 numTokens) public {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbo.balanceOf(msg.sender) &gt;= numTokens);
    uint256 voteTokenBalance = bbs.getUint(BBLib.toB32(msg.sender,'STAKED_VOTE'));
    require(bbo.transferFrom(msg.sender, address(this), numTokens));
    bbs.setUint(BBLib.toB32(msg.sender,'STAKED_VOTE'), voteTokenBalance.add(numTokens));
    emit VotingRightsGranted(msg.sender, numTokens);
  }
  
  /**
   * @dev withdraw voting rights
   * 
   */
<span class="fstat-no" title="function not covered" >  function withdrawVotingRights(uint256 numTokens) public </span>
  {
<span class="cstat-no" title="statement not covered" >    uint256 voteTokenBalance = bbs.getUint(BBLib.toB32(msg.sender,'STAKED_VOTE'))</span>;
<span class="cstat-no" title="statement not covered" >    require (voteTokenBalance &gt; 0)</span>;
<span class="cstat-no" title="statement not covered" >    require (numTokens &gt; 0)</span>;
<span class="cstat-no" title="statement not covered" >    require (numTokens&lt;= voteTokenBalance)</span>;
    bbs.setUint(BBLib.toB32(msg.sender,'STAKED_VOTE'), voteTokenBalance.sub(numTokens));
<span class="cstat-no" title="statement not covered" >    require(bbo.transfer(msg.sender, numTokens))</span>;
<span class="cstat-no" title="statement not covered" >    emit VotingRightsWithdrawn(msg.sender, numTokens);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function checkBalance() public view returns(uint256 tokens)</span>{
<span class="cstat-no" title="statement not covered" >    tokens = bbs.getUint(BBLib.toB32(msg.sender,'STAKED_VOTE'))</span>;
  }
  /**
   * @dev commitVote for poll
   * @param jobHash Job Hash
   * @param secretHash Hash of Choice address and salt uint
   */
  function commitVote(bytes jobHash, bytes32 secretHash, uint256 tokens) public 
  isDisputeJob(jobHash)
  {
    uint256 pollId = getPollID(jobHash);
    uint256 minVotes = bbs.getUint(keccak256('MIN_VOTES'));
    uint256 maxVotes = bbs.getUint(keccak256('MAX_VOTES'));
    <span class="missing-if-branch" title="else path not taken" >E</span>require(tokens &gt;= minVotes);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(tokens &lt;= maxVotes);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(isAgaintsPoll(jobHash)==true);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getUint(BBLib.toB32(jobHash, pollId,'EVEIDENCE_ENDDATE'))&lt;now);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getUint(BBLib.toB32(jobHash, pollId,'COMMIT_ENDDATE'))&gt;now);
&nbsp;
    <span class="missing-if-branch" title="else path not taken" >E</span>require(secretHash != 0);
    
    uint256 voteTokenBalance = bbs.getUint(BBLib.toB32(msg.sender,'STAKED_VOTE'));
    if(voteTokenBalance&lt;tokens){
      requestVotingRights(tokens.sub(voteTokenBalance));
    }
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getUint(BBLib.toB32(msg.sender,'STAKED_VOTE')) &gt;= tokens);
    // add secretHash
    bbs.setBytes(BBLib.toB32(jobHash,pollId,'SECRET_HASH',msg.sender), abi.encodePacked(secretHash));
    bbs.setUint(BBLib.toB32(jobHash,pollId,'VOTES',msg.sender), tokens);
    emit VoteCommitted(msg.sender, jobHash);
  }
&nbsp;
  /**
  * @dev check Hash for poll
  * @param jobHash Job Hash
  * @param choice address 
  * @param salt salt
  */
<span class="fstat-no" title="function not covered" >  function checkHash(bytes jobHash, address choice, uint salt) public view returns(bool)</span>{
<span class="cstat-no" title="statement not covered" >    uint256 pollId = getPollID(jobHash)</span>;
<span class="cstat-no" title="statement not covered" >    bytes32 choiceHash = BBLib.toB32(choice,salt)</span>;
<span class="cstat-no" title="statement not covered" >    bytes32 secretHash = BBLib.bytesToBytes32(bbs.getBytes(BBLib.toB32(jobHash,pollId,'SECRET_HASH',msg.sender)))</span>;
<span class="cstat-no" title="statement not covered" >    return (choiceHash==secretHash);</span>
  }
  /**
  * @dev revealVote for poll
  * @param jobHash Job Hash
  * @param choice address 
  * @param salt salt
  */
  function revealVote(bytes jobHash, address choice, uint salt) public 
  isDisputeJob(jobHash)
  {
    uint256 pollId = getPollID(jobHash);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(isAgaintsPoll(jobHash)==true);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getUint(BBLib.toB32(jobHash, pollId,'COMMIT_ENDDATE'))&lt;now);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getUint(BBLib.toB32(jobHash, pollId,'REVEAL_ENDDATE'))&gt;now);
&nbsp;
    uint256 voteTokenBalance = bbs.getUint(BBLib.toB32(msg.sender,'STAKED_VOTE'));
    uint256 votes = bbs.getUint(BBLib.toB32(jobHash, pollId,'VOTES',msg.sender));
    // check staked vote
    <span class="missing-if-branch" title="else path not taken" >E</span>require(voteTokenBalance&gt;= votes);
&nbsp;
    bytes32 choiceHash = BBLib.toB32(choice,salt);
    bytes32 secretHash = BBLib.bytesToBytes32(bbs.getBytes(BBLib.toB32(jobHash, pollId,'SECRET_HASH',msg.sender)));
    require(choiceHash == secretHash);
    uint256 numVote = bbs.getUint(BBLib.toB32(jobHash, pollId,'VOTE_FOR',choice));
    //save result poll
    bbs.setUint(BBLib.toB32(jobHash, pollId,'VOTE_FOR',choice), numVote.add(votes));
    // save voter choice
    bbs.setAddress(BBLib.toB32(jobHash, pollId,'CHOICE',msg.sender), choice);
    emit VoteRevealed(msg.sender, jobHash, secretHash,choiceHash);
  }
  /**
  * @dev claimReward for poll
  * @param jobHash Job Hash
  *
  */
  function claimReward(bytes jobHash) public {
    uint256 pollId = getPollID(jobHash);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getUint(BBLib.toB32(jobHash,pollId,'REVEAL_ENDDATE'))&lt;=now);
    <span class="missing-if-branch" title="else path not taken" >E</span>require(bbs.getBool(BBLib.toB32(jobHash,pollId,'REWARD_CLAIMED',msg.sender))!= true);
    uint256 numReward = calcReward(jobHash);
<span class="cstat-no" title="statement not covered" >    require (numReward &gt; 0)</span>;
    // set claimed to true
    bbs.setBool(BBLib.toB32(jobHash,pollId,'REWARD_CLAIMED',msg.sender), true);
<span class="cstat-no" title="statement not covered" >    require(bbo.transferFrom(bboReward, msg.sender, numReward))</span>;
  }
  /**
  * @dev calcReward calculate the reward
  * @param jobHash Job Hash
  *
  */
  function calcReward(bytes jobHash) constant public returns(uint256 numReward){
    uint256 pollId = getPollID(jobHash);
    address winner = bbs.getAddress(BBLib.toB32(jobHash, 'DISPUTE_WINNER'));
    <span class="missing-if-branch" title="if path not taken" >I</span>require(winner!=address(0x0));
<span class="cstat-no" title="statement not covered" >    address choice = bbs.getAddress(BBLib.toB32(jobHash, pollId, 'CHOICE',msg.sender))</span>;
<span class="cstat-no" title="statement not covered" >    if(choice == winner){</span>
<span class="cstat-no" title="statement not covered" >      uint256 votes = bbs.getUint(BBLib.toB32(jobHash, pollId, 'VOTES',msg.sender))</span>;
<span class="cstat-no" title="statement not covered" >      uint256 totalVotes = bbs.getUint(BBLib.toB32(jobHash, pollId, 'VOTE_FOR',choice))</span>;
<span class="cstat-no" title="statement not covered" >      uint256 bboStake = bbs.getUint(BBLib.toB32(jobHash, pollId, 'STAKED_DEPOSIT',choice))</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >      numReward = votes.mul(bboStake).div(totalVotes)</span>; // (vote/totalVotes) * staked
&nbsp;
    }else{
<span class="cstat-no" title="statement not covered" >      numReward = bbs.getUint(keccak256('BBO_REWARDS'))</span>;
    }
  }
  
  
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Sep 04 2018 15:02:36 GMT+0700 (+07)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
